% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fx_backtest.R
\name{fx_backtest}
\alias{fx_backtest}
\title{FX Backtest}
\usage{
fx_backtest(
  prices,
  theo_weights,
  base_currency_rates,
  quote_currency_rates,
  swap_rates = NULL,
  trade_buffer = 0,
  initial_cash = 10000,
  commission_pct = 0,
  capitalise_profits = FALSE,
  include_initial_state = FALSE
)
}
\arguments{
\item{prices}{Matrix of exchange rates. Column 1 must be the timestamp or index.}

\item{theo_weights}{Matrix of theoretical weights. Column 1 must be the timestamp or index.
Positive = long base currency, negative = short base currency.}

\item{base_currency_rates}{Matrix of XXX/USD rates for each pair's base currency.
Used for position sizing (converting USD equity to base currency units).
For XXX/USD pairs, this equals the pair's price.
For USD/XXX pairs, this is 1.0 (base is USD).
For crosses like EUR/JPY, this is the EUR/USD rate.}

\item{quote_currency_rates}{Matrix of multipliers to convert quote-currency P&L to USD.
For XXX/USD pairs, this is 1.0 (P&L already in USD).
For USD/XXX pairs, this is 1/USDXXX (e.g., 1/USDJPY).
For crosses like EUR/JPY, this is 1/USDJPY.}

\item{swap_rates}{Matrix of daily swap rates. Must have paired columns for each pair:
{PAIR}_long and {PAIR}_short. Positive = credit, negative = debit.
If NULL, no swap costs are applied.}

\item{trade_buffer}{Trade buffer parameter - rebalance when position deviates by more than this}

\item{initial_cash}{Initial cash balance in USD}

\item{commission_pct}{Percent commission charged on trades (as decimal, e.g., 0.0001 = 1bp)}

\item{capitalise_profits}{If TRUE, use current equity (including profits) for position sizing.
If FALSE, use min(initial_cash, equity) - profits accrue but don't compound.}

\item{include_initial_state}{If TRUE, prepends an initial state row (t=0) to results.}
}
\value{
Long dataframe of results with columns:
ticker, Date, Close, Position, Value, PnlQuote, PnlUsd, Swap, Trades, TradeValue, Commission
}
\description{
Quasi event-based simulation for FX portfolios with proper
USD-denominated P&L conversion for all pair types (XXX/USD, USD/XXX, and crosses).

This function works for both spot FX and FX CFDs. The P&L mechanics are
identical: regardless of instrument type, P&L accrues in the quote currency
and must be converted to your account currency (USD). For example, trading
AUD/JPY generates P&L in JPY whether spot or CFD - the quote_currency_rates
matrix handles the conversion to USD.
}
\details{
\code{theo_weights} should be date-aligned with \code{prices} - it is up to the user to lag
\code{theo_weights} as necessary to ensure that trades occur at appropriate prices.

Position sizing works as follows:
\enumerate{
\item cap_equity = capitalise_profits ? equity : min(initial_cash, equity)
\item target_value_usd = cap_equity * weight
\item target_position = target_value_usd / base_currency_rate
}

P&L is calculated as:
\enumerate{
\item pnl_quote = position * (current_price - previous_price)
\item pnl_usd = pnl_quote * quote_currency_rate
}
}
\section{Spot FX vs CFDs}{

This function handles both spot FX and FX CFDs identically because the P&L
calculation is the same:
\itemize{
\item P&L always accrues in the quote currency (e.g., JPY for AUD/JPY)
\item The \code{quote_currency_rates} matrix converts this to USD
\item Swap rates (spot) and financing charges (CFDs) are handled via \code{swap_rates}
}
The only difference is settlement mechanism (physical vs cash), which doesn't
affect backtesting calculations.
}

\examples{
\dontrun{
results <- fx_backtest(
  prices = prices_matrix,
  theo_weights = weights_matrix,
  base_currency_rates = base_rates,
  quote_currency_rates = quote_rates,
  trade_buffer = 0.05,
  initial_cash = 100000,
  commission_pct = 0.00005,
  capitalise_profits = TRUE
)
}
}
